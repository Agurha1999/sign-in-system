<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign In (LocalStorage)</title>
  <style>
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      box-sizing: border-box;
    }
    textarea { resize: vertical; height: 40px; }
    .button-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      align-items: center;
    }
    button { padding: 10px 20px; cursor: pointer; }
    .error-message { color: red; margin-top: 10px; }
    .success-message { color: green; margin-top: 10px; font-weight: bold; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd; padding: 8px; text-align: left;
    }
    th { background-color: #eee; }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Sign In (LocalStorage)</h2>
    <form id="signInForm">
      <input type="text" id="name" placeholder="Name *" required />
      <input type="text" id="phone" placeholder="Phone *" required />
      <input type="text" id="company" placeholder="Company *" required />
      <input type="text" id="trade" placeholder="Trade" />

      <select id="ppe" required>
        <option disabled selected>Do you have all PPE to safely complete the job? *</option>
        <option value="Fully equipped">Fully equipped</option>
        <option value="Other">Other (explain in comments)</option>
      </select>

      <select id="risk" required>
        <option disabled selected>Have you read and understood the property risk profile? *</option>
        <option value="Understood">Understood</option>
        <option value="Other">Other (explain in comments)</option>
      </select>

      <select id="hazard" required>
        <option disabled selected>Have you read and understood the Job Specific Site Hazards? *</option>
        <option value="Understood">Understood</option>
        <option value="Other">Other (explain in comments)</option>
      </select>

      <textarea id="comments" placeholder="Comments (required if selecting 'Other')"></textarea>

      <select id="keySelect" required>
        <option value="" disabled selected>Select Key *</option>
      </select>

      <div class="button-row">
        <button type="button" onclick="goHome()">Home</button>
        <button type="submit">Submit</button>
      </div>
    </form>

    <p id="errorMessage" class="error-message"></p>
    <p id="successMessage" class="success-message"></p>

    <h3>Currently Signed-In</h3>
    <table id="activeTable">
      <thead>
        <tr><th>Name</th><th>Company</th><th>Sign-In Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Load keys from localStorage or set example keys
    const keysKey = 'keys';
    const signInsKey = 'signIns';

    function loadKeys() {
      let keys = JSON.parse(localStorage.getItem(keysKey) || '[]');
      if (keys.length === 0) {
        // Example keys if none in storage
        keys = ['Site A', 'Site B', 'Site C'];
        localStorage.setItem(keysKey, JSON.stringify(keys));
      }
      const keySelect = document.getElementById('keySelect');
      keys.forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        keySelect.appendChild(opt);
      });
    }

    function saveSignIn(data) {
      let signIns = JSON.parse(localStorage.getItem(signInsKey) || '[]');
      signIns.push(data);
      localStorage.setItem(signInsKey, JSON.stringify(signIns));
    }

    function loadActive() {
      const signIns = JSON.parse(localStorage.getItem(signInsKey) || '[]');
      const tbody = document.querySelector('#activeTable tbody');
      tbody.innerHTML = '';

      signIns.forEach(entry => {
        if (!entry.signOutTime) {
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td');
          nameTd.textContent = entry.name;
          const companyTd = document.createElement('td');
          companyTd.textContent = entry.company;
          const timeTd = document.createElement('td');
          timeTd.textContent = new Date(entry.signInTime).toLocaleString();

          tr.appendChild(nameTd);
          tr.appendChild(companyTd);
          tr.appendChild(timeTd);
          tbody.appendChild(tr);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadKeys();

      const form = document.getElementById('signInForm');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      form.addEventListener('submit', (e) => {
        e.preventDefault();

        errorMessage.textContent = '';
        successMessage.textContent = '';

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const company = document.getElementById('company').value.trim();
        const trade = document.getElementById('trade').value.trim();
        const ppe = document.getElementById('ppe').value;
        const risk = document.getElementById('risk').value;
        const hazard = document.getElementById('hazard').value;
        const comments = document.getElementById('comments').value.trim();
        const key = document.getElementById('keySelect').value;

        if (!name || !phone || !company || !ppe || !risk || !hazard || !key) {
          errorMessage.textContent = "Please fill in all required fields marked with *.";
          return;
        }

        if ((ppe === "Other" || risk === "Other" || hazard === "Other") && !comments) {
          errorMessage.textContent = "Please explain in the comments field.";
          return;
        }

        const signInEntry = {
          name,
          phone,
          company,
          trade,
          ppe,
          risk,
          hazard,
          other: comments,
          key,
          signInTime: new Date().toISOString(),
          signOutTime: null
        };

        saveSignIn(signInEntry);

        successMessage.textContent = "Sign-In recorded successfully!";
        form.reset();
        loadActive();
      });

      loadActive();
    });

    function goHome() {
      alert("Going home (implement as needed).");
      // window.location.href = 'index.html'; // Uncomment if you have a home page
    }
  </script>
</body>
</html>
