<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign In</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin: 6px 0; box-sizing: border-box;
    }
    .button-row { display: flex; justify-content: space-between; margin-top: 10px; }
    .error-message { color: red; margin-top: 10px; }
    .success-message { color: green; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Sign In</h2>
  <form id="signInForm">
    <input type="text" id="name" placeholder="Name *" required />
    <input type="text" id="phone" placeholder="Phone *" required />
    <input type="text" id="company" placeholder="Company *" required />
    <input type="text" id="trade" placeholder="Trade" />
    
    <select id="ppe" required>
      <option disabled selected>Do you have all PPE to safely complete the job? *</option>
      <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
      <option value="Other (explain in comments)">Other (explain in comments)</option>
    </select>
    
    <select id="risk" required>
      <option disabled selected>Have you read and understood the property risk profile? *</option>
      <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
      <option value="Other (explain in comments)">Other (explain in comments)</option>
    </select>
    
    <select id="hazard" required>
      <option disabled selected>Have you read and understood the Job Specific Site Hazards? *</option>
      <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
      <option value="Other (explain in comments)">Other (explain in comments)</option>
    </select>
    
    <textarea id="comments" placeholder="Comments (required if selecting 'Other')" rows="2"></textarea>

    <select id="keySelect" required>
      <option value="">Select Key *</option>
    </select>

    <div class="button-row">
      <button type="button" onclick="goHome()">Home</button>
      <button type="submit">Submit</button>
    </div>
  </form>

  <p id="errorMessage" class="error-message"></p>
  <p id="successMessage" class="success-message"></p>

  <script>
    function goHome() {
      window.location.href = 'index.html';
    }

    // Load keys from localStorage into dropdown
    function loadKeys() {
      const keySelect = document.getElementById('keySelect');
      const keys = JSON.parse(localStorage.getItem('keys') || '[]');
      if (!keys.length) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "No keys available. Contact Admin.";
        opt.disabled = true;
        keySelect.appendChild(opt);
      } else {
        keys.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          keySelect.appendChild(option);
        });
      }
    }

    // Save sign-in to localStorage
    function saveSignIn(record) {
      const logs = JSON.parse(localStorage.getItem('signLogs') || '[]');
      logs.push(record);
      localStorage.setItem('signLogs', JSON.stringify(logs));

      const active = JSON.parse(localStorage.getItem('activeSignIns') || '[]');
      active.push(record);
      localStorage.setItem('activeSignIns', JSON.stringify(active));
    }

    // Form submission logic
    document.addEventListener('DOMContentLoaded', () => {
      loadKeys();

      const form = document.getElementById('signInForm');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      form.addEventListener('submit', function (e) {
        e.preventDefault();

        errorMessage.textContent = "";
        successMessage.textContent = "";

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const company = document.getElementById('company').value.trim();
        const trade = document.getElementById('trade').value.trim();
        const ppe = document.getElementById('ppe').value;
        const risk = document.getElementById('risk').value;
        const hazard = document.getElementById('hazard').value;
        const comments = document.getElementById('comments').value.trim();
        const key = document.getElementById('keySelect').value;

        if (!name || !phone || !company || !ppe || !risk || !hazard || !key) {
          errorMessage.textContent = "Please fill in all required fields marked with *.";
          return;
        }

        if (
          (ppe.includes("Other") || risk.includes("Other") || hazard.includes("Other")) &&
          comments === ""
        ) {
          errorMessage.textContent = "Please explain in the comments field.";
          return;
        }

        const record = {
          name,
          phone,
          company,
          trade,
          ppe,
          risk,
          hazard,
          other: comments,
          key,
          signInTime: new Date().toISOString(),
          signOutTime: null
        };

        saveSignIn(record);
        successMessage.textContent = "Sign-In recorded successfully! Redirecting to home page...";
        form.reset();

        setTimeout(() => {
          window.location.href = 'index.html';
        }, 3000);
      });
    });
  </script>
</body>
</html>
