<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign In</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }

    .form-container input,
    .form-container select,
    .form-container textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      box-sizing: border-box;
    }

    #comments {
      height: 40px;
      resize: vertical;
    }

    .button-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      align-items: center;
    }

    .form-container button {
      padding: 10px 20px;
      cursor: pointer;
    }

    .error-message {
      color: red;
      margin-top: 10px;
    }

    .success-message {
      color: green;
      margin-top: 10px;
      font-weight: bold;
    }

    /* Table styles for active sign-ins */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Sign In</h2>
    <form id="signInForm">
      <input type="text" id="name" placeholder="Name *" required />
      <input type="text" id="phone" placeholder="Phone *" required />
      <input type="text" id="company" placeholder="Company *" required />
      <input type="text" id="trade" placeholder="Trade" />

      <select id="ppe" required>
        <option disabled selected>Do you have all PPE to safely complete the job? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <select id="risk" required>
        <option disabled selected>Have you read and understood the property risk profile? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <select id="hazard" required>
        <option disabled selected>Have you read and understood the Job Specific Site Hazards? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <textarea id="comments" placeholder="Comments (required if selecting 'Other')" rows="1"></textarea>

      <select id="keySelect" required>
        <option value="">Select Key *</option>
      </select>

      <div class="button-row">
        <button type="button" onclick="goHome()">Home</button>
        <button type="submit">Submit</button>
      </div>
    </form>

    <p id="errorMessage" class="error-message"></p>
    <p id="successMessage" class="success-message"></p>

    <!-- Active sign-ins table -->
    <h3>Currently Signed-In</h3>
    <table id="activeTable">
      <thead>
        <tr><th>Name</th><th>Company</th><th>Sign-In Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwMccJvXYr0xJ1kSCVihg34MB39WPQxRy1EezOpE-5wMq9_kFRbpgH-O3UPJ7QtC6tf/exec';

    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      return res.json();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('signInForm');
      const keySelect = document.getElementById('keySelect');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      // Load keys from localStorage into dropdown
      const keys = JSON.parse(localStorage.getItem('keys') || '[]');
      if (!keys.length) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "No keys available. Contact Admin.";
        opt.disabled = true;
        keySelect.appendChild(opt);
      } else {
        keys.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          keySelect.appendChild(option);
        });
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        errorMessage.textContent = "";
        successMessage.textContent = "";

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const company = document.getElementById('company').value.trim();
        const trade = document.getElementById('trade').value.trim();
        const ppe = document.getElementById('ppe').value;
        const risk = document.getElementById('risk').value;
        const hazard = document.getElementById('hazard').value;
        const comments = document.getElementById('comments').value.trim();
        const key = keySelect.value;

        if (!name || !phone || !company || !ppe || !risk || !hazard || !key) {
          errorMessage.textContent = "Please fill in all required fields marked with *.";
          return;
        }

        if (
          (ppe === "Other (explain in comments)" ||
           risk === "Other (explain in comments)" ||
           hazard === "Other (explain in comments)") &&
          comments === ""
        ) {
          errorMessage.textContent = "Please explain in the comments field.";
          return;
        }

        const data = {
          name,
          phone,
          company,
          trade,
          ppe,
          risk,
          hazard,
          other: comments,  // keep original field 'other' consistent with your backend, if needed
          key,
          signInTime: new Date().toISOString(),
          signOutTime: null,
          action: 'signIn'
        };

        try {
          const response = await apiPost(data);
          if (response.status === 'success') {
            successMessage.textContent = "Sign-In recorded successfully! Redirecting to home page...";
            form.reset();
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 5000);
            loadActive();
          } else {
            errorMessage.textContent = response.message || "Sign-In failed.";
          }
        } catch (err) {
          errorMessage.textContent = "Error connecting to server.";
          console.error(err);
        }
      });

      // Load active sign-ins initially and refresh every 30s
      loadActive();
      setInterval(loadActive, 30000);
    });

    async function loadActive() {
      try {
        const response = await apiPost({action: 'getActive'});
        if (response.status === 'success') {
          const tbody = document.querySelector('#activeTable tbody');
          tbody.innerHTML = '';
          response.active.forEach(row => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = row[1];
            const companyTd = document.createElement('td');
            companyTd.textContent = row[3];
            const timeTd = document.createElement('td');
            timeTd.textContent = new Date(row[10]).toLocaleString();
            tr.appendChild(nameTd);
            tr.appendChild(companyTd);
            tr.appendChild(timeTd);
            tbody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error("Failed to load active sign-ins:", err);
      }
    }

    function goHome() {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign In</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .form-container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }

    .form-container input,
    .form-container select,
    .form-container textarea {
      width: 100%;
      padding: 10px;
      margin: 6px 0;
      box-sizing: border-box;
    }

    #comments {
      height: 40px;
      resize: vertical;
    }

    .button-row {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      align-items: center;
    }

    .form-container button {
      padding: 10px 20px;
      cursor: pointer;
    }

    .error-message {
      color: red;
      margin-top: 10px;
    }

    .success-message {
      color: green;
      margin-top: 10px;
      font-weight: bold;
    }

    /* Table styles for active sign-ins */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Sign In</h2>
    <form id="signInForm">
      <input type="text" id="name" placeholder="Name *" required />
      <input type="text" id="phone" placeholder="Phone *" required />
      <input type="text" id="company" placeholder="Company *" required />
      <input type="text" id="trade" placeholder="Trade" />

      <select id="ppe" required>
        <option disabled selected>Do you have all PPE to safely complete the job? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <select id="risk" required>
        <option disabled selected>Have you read and understood the property risk profile? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <select id="hazard" required>
        <option disabled selected>Have you read and understood the Job Specific Site Hazards? *</option>
        <option value="I am fully equipped to carry out the job safely">I am fully equipped to carry out the job safely</option>
        <option value="Other (explain in comments)">Other (explain in comments)</option>
      </select>

      <textarea id="comments" placeholder="Comments (required if selecting 'Other')" rows="1"></textarea>

      <select id="keySelect" required>
        <option value="">Select Key *</option>
      </select>

      <div class="button-row">
        <button type="button" onclick="goHome()">Home</button>
        <button type="submit">Submit</button>
      </div>
    </form>

    <p id="errorMessage" class="error-message"></p>
    <p id="successMessage" class="success-message"></p>

    <!-- Active sign-ins table -->
    <h3>Currently Signed-In</h3>
    <table id="activeTable">
      <thead>
        <tr><th>Name</th><th>Company</th><th>Sign-In Time</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwMccJvXYr0xJ1kSCVihg34MB39WPQxRy1EezOpE-5wMq9_kFRbpgH-O3UPJ7QtC6tf/exec';

    async function apiPost(data) {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      return res.json();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('signInForm');
      const keySelect = document.getElementById('keySelect');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');

      // Load keys from localStorage into dropdown
      const keys = JSON.parse(localStorage.getItem('keys') || '[]');
      if (!keys.length) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "No keys available. Contact Admin.";
        opt.disabled = true;
        keySelect.appendChild(opt);
      } else {
        keys.forEach(key => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = key;
          keySelect.appendChild(option);
        });
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        errorMessage.textContent = "";
        successMessage.textContent = "";

        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const company = document.getElementById('company').value.trim();
        const trade = document.getElementById('trade').value.trim();
        const ppe = document.getElementById('ppe').value;
        const risk = document.getElementById('risk').value;
        const hazard = document.getElementById('hazard').value;
        const comments = document.getElementById('comments').value.trim();
        const key = keySelect.value;

        if (!name || !phone || !company || !ppe || !risk || !hazard || !key) {
          errorMessage.textContent = "Please fill in all required fields marked with *.";
          return;
        }

        if (
          (ppe === "Other (explain in comments)" ||
           risk === "Other (explain in comments)" ||
           hazard === "Other (explain in comments)") &&
          comments === ""
        ) {
          errorMessage.textContent = "Please explain in the comments field.";
          return;
        }

        const data = {
          name,
          phone,
          company,
          trade,
          ppe,
          risk,
          hazard,
          other: comments,  // keep original field 'other' consistent with your backend, if needed
          key,
          signInTime: new Date().toISOString(),
          signOutTime: null,
          action: 'signIn'
        };

        try {
          const response = await apiPost(data);
          if (response.status === 'success') {
            successMessage.textContent = "Sign-In recorded successfully! Redirecting to home page...";
            form.reset();
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 5000);
            loadActive();
          } else {
            errorMessage.textContent = response.message || "Sign-In failed.";
          }
        } catch (err) {
          errorMessage.textContent = "Error connecting to server.";
          console.error(err);
        }
      });

      // Load active sign-ins initially and refresh every 30s
      loadActive();
      setInterval(loadActive, 30000);
    });

    async function loadActive() {
      try {
        const response = await apiPost({action: 'getActive'});
        if (response.status === 'success') {
          const tbody = document.querySelector('#activeTable tbody');
          tbody.innerHTML = '';
          response.active.forEach(row => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.textContent = row[1];
            const companyTd = document.createElement('td');
            companyTd.textContent = row[3];
            const timeTd = document.createElement('td');
            timeTd.textContent = new Date(row[10]).toLocaleString();
            tr.appendChild(nameTd);
            tr.appendChild(companyTd);
            tr.appendChild(timeTd);
            tbody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error("Failed to load active sign-ins:", err);
      }
    }

    function goHome() {
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>

